AWSTemplateFormatVersion: "2010-09-09"
Description: AWS CloudFormation Template for a Free Tier eligible RDS PostgreSQL Instance.

Parameters:
  DBInstanceIdentifier:
    Type: String
    Default: mvp-db-instance
    Description: The database instance identifier.
  DBName:
    Type: String
    Default: mvpdb
    Description: The name of the database to create.
  DBUser:
    Type: String
    Default: mvpuser
    Description: The master username for the database.
  DBPassword:
    Type: String
    NoEcho: true
    Description: The master password for the database.
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The VPC ID where the RDS instance will be launched. (Use the default VPC ID)

Resources:
  # ============================================
  # RDS Subnet Group
  # ============================================
  RDSDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS instance
      SubnetIds: !Ref SubnetIds  # Se pasa como par√°metro
      DBSubnetGroupName: !Sub "${DBInstanceIdentifier}-subnet-group"

  # ============================================
  # RDS Instance
  # ============================================
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Ref DBInstanceIdentifier
      DBName: !Ref DBName
      Engine: postgres
      EngineVersion: 14.7
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      DBInstanceClass: db.t2.micro
      AllocatedStorage: 20
      StorageType: gp2
      BackupRetentionPeriod: 0
      MultiAZ: false
      PubliclyAccessible: true
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref RDSDBSubnetGroup
      LicenseModel: postgresql-license

Outputs:
  DBEndpointAddress:
    Description: The endpoint address of the RDS instance
    Value: !GetAtt RDSInstance.Endpoint.Address
  DBEndpointPort:
    Description: The endpoint port of the RDS instance
    Value: !GetAtt RDSInstance.Endpoint.Port
  RDSSecurityGroupId:
    Description: The Security Group ID for the RDS instance
    Value: !Ref RDSSecurityGroup